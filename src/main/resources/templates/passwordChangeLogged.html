<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Alterar senha</title>
  <link rel="stylesheet" th:href="@{/css/index.css}" />
</head>
<body>
<div class="auth-container">
  <div class="auth-header">
    <a href="/">
      <div class="store-logo">
        <div class="store-logo-icon">U</div>
        <div class="store-name">UniWare</div>
      </div>
    </a>
    <h2 class="auth-title">Alterar senha</h2>
    <p class="error" th:if="${error}" th:text="${error}" style="color: red;"></p>
    <p class="success" th:if="${success}" th:text="${success}" style="color: green;"></p>
  </div>

  <form class="auth-form" th:action="@{/changePasswordLogged}" method="post">
    <input type="hidden" name="email" th:value="${loggedUser.email}" />

    <div class="form-group">
      <label class="form-label" for="oldPassword">Senha atual</label>
      <input class="form-input" type="password" id="oldPassword" name="oldPassword" placeholder="Digite sua senha atual" required>
    </div>

    <div class="form-group">
      <label class="form-label" for="newPassword">Nova senha</label>
      <input class="form-input" type="password" id="newPassword" name="newPassword" placeholder="Digite a nova senha" required>
    </div>

    <button class="submit-btn" type="submit">Alterar senha</button>
  </form>

  <div class="auth-footer">
    <div class="auth-links">
      <a href="/profile" class="auth-link primary-link">Voltar ao perfil</a>
    </div>
  </div>
</div>

<script>
  (function () {
    const fields = document.querySelectorAll('.auth-form .form-group .form-input');

    fields.forEach(input => {
      const parent = input.parentElement;
      parent.style.position = 'relative';

      const icon = document.createElement('span');
      icon.classList.add('validation-icon', 'neutral');
      icon.innerHTML = getIconSVG('neutral');
      parent.appendChild(icon);

      // Adicionar botão de mostrar senha para cada campo de senha
      if (input.type === 'password') {
        const eye = document.createElement('span');
        eye.classList.add('toggle-password');
        eye.innerHTML = getEyeSVG(false);
        parent.appendChild(eye);

        eye.addEventListener('click', () => {
          const visible = input.type === 'text';
          input.type = visible ? 'password' : 'text';
          eye.innerHTML = getEyeSVG(!visible);
        });

        eye.style.position = 'absolute';
        eye.style.right = '35px';
        eye.style.top = '50%';
        eye.style.transform = 'translateY(-50%)';
        eye.style.cursor = 'pointer';
        eye.style.width = '20px';
        eye.style.height = '20px';
      }

      input.addEventListener('input', () => {
        const value = input.value.trim();

        if (!value) {
          input.setCustomValidity('');
          setIconState(icon, 'neutral');
          return;
        }

        // Validação da senha atual (qualquer valor é válido, apenas não vazio)
        if (input.id === 'oldPassword') {
          const ok = value.length >= 1;
          input.setCustomValidity(ok ? '' : 'Informe sua senha atual.');
          setIconState(icon, ok ? 'valid' : 'invalid');
          return;
        }

        // Validação da nova senha (mesma regra do registro)
        if (input.id === 'newPassword') {
          const len = value.length;
          const ok = len >= 8 && len <= 64;
          input.setCustomValidity(ok ? '' : 'A nova senha deve ter entre 8 e 64 caracteres.');
          setIconState(icon, ok ? 'valid' : 'invalid');
          return;
        }
      });
    });

    function setIconState(icon, state) {
      icon.classList.remove('neutral', 'valid', 'invalid');
      icon.classList.add(state);
      icon.innerHTML = getIconSVG(state);
    }

    function getIconSVG(state) {
      const size = 18;
      if (state === 'valid') {
        return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle><path d="M9 12l2 2 4-4"></path></svg>`;
      }
      if (state === 'invalid') {
        return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#d50000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle><path d="M15 9l-6 6M9 9l6 6"></path></svg>`;
      }
      return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#9e9e9e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>`;
    }

    function getEyeSVG(open) {
      const size = 18;
      if (open) {
        return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#424242" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>`;
      }
      return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#424242" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.59 21.59 0 0 1 5.06-5.94"/><path d="M1 1l22 22"/></svg>`;
    }
  })();
</script>

</body>
</html>
