<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/index.css}" />
    <title>Registro</title>
</head>
<body>
<div class="auth-container">
    <div class="auth-header">
        <a href="/">
            <div class="store-logo">
                <div class="store-logo-icon">U</div>
                <div class="store-name">UniWare</div>
            </div>
        </a>
        <h2 class="auth-title">Criar sua conta</h2>
        <p th:text="${emailAlreadyRegisteredError}" style="color: red;"></p>
    </div>

    <form class="auth-form" action="/register" method="post">
        <div class="form-group">
            <label class="form-label" for="name">Nome completo</label>
            <input class="form-input" type="text" name="name" id="name" placeholder="Digite seu nome completo" pattern="[A-Za-zÀ-ÿ\s]{3,100}" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="age">Idade</label>
            <input class="form-input" type="number" name="age" id="age" min="1" max="120" placeholder="Digite sua idade" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="cpf">CPF</label>
            <input class="form-input" type="text" name="cpf" id="cpf" placeholder="Digite seu CPF" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input class="form-input" type="email" name="email" id="email" placeholder="Digite seu email" maxlength="100" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="password">Senha</label>
            <input class="form-input" type="password" name="password" id="password" placeholder="Digite sua senha" minlength="8" maxlength="64" required>
        </div>

        <button class="submit-btn" type="submit">Cadastrar</button>
    </form>

    <div class="auth-footer">
        <div class="auth-links">
            <a href="/login" class="auth-link primary-link">Já tem conta? Entre aqui</a>
        </div>
    </div>
</div>

<script>
    (function () {

      const fields = document.querySelectorAll('.auth-form .form-group .form-input');

      fields.forEach(input => {
        const parent = input.parentElement;
        parent.style.position = 'relative';

        const icon = document.createElement('span');
        icon.classList.add('validation-icon', 'neutral');
        icon.innerHTML = getIconSVG('neutral');
        parent.appendChild(icon);

        input.addEventListener('input', () => {
          const value = input.value.trim();

          if (!value) {
            setIconState(icon, 'neutral');
            return;
          }

          let isValid = input.checkValidity();

          if (input.id === 'cpf') {
            const raw = value.replace(/\D/g, '');
            isValid = validarCPF(raw);
          }

          if (isValid) {
            setIconState(icon, 'valid');
          } else {
            setIconState(icon, 'invalid');
          }
        });
      });

      function setIconState(icon, state) {
        icon.classList.remove('neutral', 'valid', 'invalid');
        icon.classList.add(state);
        icon.innerHTML = getIconSVG(state);
      }

      function getIconSVG(state) {
        const size = 18;
        if (state === 'valid') {
          return `
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9 12l2 2 4-4"></path>
            </svg>`;
        }
        if (state === 'invalid') {
          return `
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#d50000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M15 9l-6 6M9 9l6 6"></path>
            </svg>`;
        }
        return `
          <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#9e9e9e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>`;
      }

      function validarCPF(raw) {
        const cpf = String(raw).replace(/\D/g, '');
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

        const calc = (slice) => {
          let soma = 0;
          let peso = slice.length + 1;
          for (let i = 0; i < slice.length; i++) soma += Number(slice[i]) * peso--;
          const resto = soma % 11;
          return resto < 2 ? 0 : 11 - resto;
        };

        const dig1 = calc(cpf.slice(0, 9));
        const dig2 = calc(cpf.slice(0, 9) + dig1);
        return Number(cpf[9]) === dig1 && Number(cpf[10]) === dig2;
      }

      const inputEmail = document.getElementById('email');
        if (inputEmail) {
          inputEmail.addEventListener('input', () => {
            const valor = inputEmail.value.trim();

            const emailRegex = /^[^@]+@[^@]+\.[^@]+$/;

            const icon = inputEmail.parentElement.querySelector('.validation-icon');
            if (!valor) {
              inputEmail.setCustomValidity('');
              icon.className = 'validation-icon neutral';
              return;
            }

            if (emailRegex.test(valor)) {
              inputEmail.setCustomValidity('');
              icon.className = 'validation-icon valid';
            } else {
              inputEmail.setCustomValidity('Email inválido.');
              icon.className = 'validation-icon invalid';
            }
          });
        }

    })();
</script>


</body>
</html>
