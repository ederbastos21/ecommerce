<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/index.css}" />
    <title>Registro</title>
</head>
<body>
<div class="auth-container">
    <div class="auth-header">
        <a href="/">
            <div class="store-logo">
                <div class="store-logo-icon">U</div>
                <div class="store-name">UniWare</div>
            </div>
        </a>
        <h2 class="auth-title">Criar sua conta</h2>
        <p th:text="${emailAlreadyRegisteredError}" style="color: red;"></p>
    </div>

    <form class="auth-form" action="/register" method="post">
        <div class="form-group">
            <label class="form-label" for="name">Nome completo</label>
            <input class="form-input" type="text" name="name" id="name" placeholder="Digite seu nome completo" pattern="[A-Za-zÀ-ÿ\s]{3,100}" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="age">Idade</label>
            <input class="form-input" type="number" name="age" id="age" min="1" max="120" placeholder="Digite sua idade" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="cpf">CPF</label>
            <input class="form-input" type="text" name="cpf" id="cpf" placeholder="Digite seu CPF" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input class="form-input" type="email" name="email" id="email" placeholder="Digite seu email" maxlength="100" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="password">Senha (min. 8 digitos)</label>
            <input class="form-input" type="password" name="password" id="password" placeholder="Digite sua senha" minlength="8" maxlength="64" required>
        </div>

        <button class="submit-btn" type="submit">Cadastrar</button>
    </form>

    <div class="auth-footer">
        <div class="auth-links">
            <a href="/login" class="auth-link primary-link">Já tem conta? Entre aqui</a>
        </div>
    </div>
</div>

<script>
    (function () {
      const fields = document.querySelectorAll('.auth-form .form-group .form-input');

      fields.forEach(input => {
        const parent = input.parentElement;
        parent.style.position = 'relative';

        const icon = document.createElement('span');
        icon.classList.add('validation-icon', 'neutral');
        icon.innerHTML = getIconSVG('neutral');
        parent.appendChild(icon);

        // For CPF we need special handling to mask while typing
        if (input.id === 'cpf') {
          input.addEventListener('input', (ev) => {
            const rawDigits = onlyDigits(input.value).slice(0, 11); // limit to 11
            const formatted = formatCPF(rawDigits);
            // preserve simple caret position as best-effort:
            const prevLen = input.value.length;
            const prevPos = input.selectionStart || prevLen;
            input.value = formatted;
            const newLen = formatted.length;
            const delta = newLen - prevLen;
            const newPos = Math.max(0, prevPos + delta);
            input.setSelectionRange(newPos, newPos);

            const isValid = rawDigits.length === 11 && validarCPF(rawDigits);
            input.setCustomValidity(isValid ? '' : 'CPF inválido.');
            setIconState(icon, isValid ? 'valid' : (rawDigits.length === 0 ? 'neutral' : 'invalid'));
          });
          // also handle paste to sanitize
          input.addEventListener('paste', (ev) => {
            ev.preventDefault();
            const text = (ev.clipboardData || window.clipboardData).getData('text');
            const digits = onlyDigits(text).slice(0,11);
            input.value = formatCPF(digits);
            input.dispatchEvent(new Event('input'));
          });
          return;
        }

        input.addEventListener('input', () => {
          const value = input.value;
          if (!value) {
            input.setCustomValidity('');
            setIconState(icon, 'neutral');
            return;
          }

          // Age (number) explicit handling
          if (input.type === 'number' || input.id === 'age') {
            const n = Number(value);
            const min = input.hasAttribute('min') ? Number(input.min) : -Infinity;
            const max = input.hasAttribute('max') ? Number(input.max) : Infinity;

            const ok = Number.isFinite(n) && n >= min && n <= max && /^\d+$/.test(value);
            input.setCustomValidity(ok ? '' : `Idade inválida (${min}-${max}).`);
            setIconState(icon, ok ? 'valid' : 'invalid');
            return;
          }

          // Email explicit (keeps the previous regex)
          if (input.type === 'email' || input.id === 'email') {
            const emailRegex = /^[^@]+@[^@]+\.[^@]+$/;
            const ok = emailRegex.test(value.trim());
            input.setCustomValidity(ok ? '' : 'Email inválido.');
            setIconState(icon, ok ? 'valid' : 'invalid');
            return;
          }

          // Password explicit: use minlength/maxlength attributes
          if (input.type === 'password' || input.id === 'password') {
            const len = value.length;
            const min = input.hasAttribute('minlength') ? Number(input.getAttribute('minlength')) : 0;
            const max = input.hasAttribute('maxlength') ? Number(input.getAttribute('maxlength')) : Infinity;
            const ok = len >= min && len <= max;
            input.setCustomValidity(ok ? '' : `Senha deve ter entre ${min} e ${max} caracteres.`);
            setIconState(icon, ok ? 'valid' : 'invalid');
            return;
          }

          // Name explicit: at least two words
          if (input.id === 'name') {
            const partes = value.trim().split(/\s+/).filter(p => p.length > 0);
            const ok = partes.length >= 2;
            input.setCustomValidity(ok ? '' : 'Digite nome e sobrenome.');
            setIconState(icon, ok ? 'valid' : 'invalid');
            return;
          }

          // Fallback generic: use browser validity but also clear customValidity if passes
          const ok = input.checkValidity();
          input.setCustomValidity(ok ? '' : 'Campo inválido.');
          setIconState(icon, ok ? 'valid' : 'invalid');
        });
      });

      function onlyDigits(s) {
        return String(s || '').replace(/\D/g, '');
      }

      function formatCPF(digits) {
        // digits is only numbers and max length 11
        const p = digits;
        if (!p) return '';
        if (p.length <= 3) return p;
        if (p.length <= 6) return `${p.slice(0,3)}.${p.slice(3)}`;
        if (p.length <= 9) return `${p.slice(0,3)}.${p.slice(3,6)}.${p.slice(6)}`;
        return `${p.slice(0,3)}.${p.slice(3,6)}.${p.slice(6,9)}-${p.slice(9,11)}`;
      }

      function setIconState(icon, state) {
        icon.classList.remove('neutral', 'valid', 'invalid');
        icon.classList.add(state);
        icon.innerHTML = getIconSVG(state);
      }

      function getIconSVG(state) {
        const size = 18;
        if (state === 'valid') {
          return `
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#00c853" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9 12l2 2 4-4"></path>
            </svg>`;
        }
        if (state === 'invalid') {
          return `
            <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#d50000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M15 9l-6 6M9 9l6 6"></path>
            </svg>`;
        }
        return `
          <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#9e9e9e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>`;
      }

      function validarCPF(raw) {
        const cpf = String(raw).replace(/\D/g, '');
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

        const calc = (slice) => {
          let soma = 0;
          let peso = slice.length + 1;
          for (let i = 0; i < slice.length; i++) soma += Number(slice[i]) * peso--;
          const resto = soma % 11;
          return resto < 2 ? 0 : 11 - resto;
        };

        const dig1 = calc(cpf.slice(0, 9));
        const dig2 = calc(cpf.slice(0, 9) + dig1);
        return Number(cpf[9]) === dig1 && Number(cpf[10]) === dig2;
      }

    })();
</script>


</body>
</html>
